## VPN (가상 사설 네트워크) : 통신 할 수 없는 원격의 사설망을 터널링하여 연결 시켜주는 것.

- 원격에 떨어져 있는 사설 네트워크를 연결하기 위한 기술이다.
- 터널링(Tunneling)을 이용해서 구성이 가능함.
- 터널링만 이용하면 데이터가 노출되어 보안에 취약함.
- IPSec, SSL/TLS 와 같은 암호화 프로토콜을 이용하여 데이터를 암호화 한다.
- VPN의 종류:
    - Site-to-Site VPN (두 네트워크를 연결) → IPSec, SSL
    - Remote VPN (원격으로 내부 네트워크에서 외부 단말을 안전하게 연결)
        
        → SSL, OpenVPN(프로토콜)
        
        → AWS 에서 제공하는 Client VPN
        
- IPSec이 사용하는 프로토콜 :
    - ESP(인증, 무결성 + 암호화)
    - AH(인증, 무결성)
        - 단일 프로토콜이 아닌 여러개의 프로토콜을 모아 사용.

![[%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-06-29_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_9.11.41.png]]

- 라우팅 정보가 없는 경우 (목적지가 불분명한 경우) 0.0.0.0으로 다 내보냄
- 라우터 0, 2는 기본경로(0.0.0.0)만 라우팅 테이블에 설정.
- 라우터 0 과 라우터 2는 라우터 1을 통해 연결이 가능하다.
- 라우터 2는 자신 인터페이스의 네트워크 정보만 라우팅 테이블에 존재하는 상태.
- R1)
    - no router bgp 1000
    - no router rip
- R2)
    - no router bgp 2000

![[%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-06-29_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_9.19.41.png]]

- 라우터 1에서 라우터 2의 네트워크가 없어 PC0 에서 해당 네트워크로의 ping이 불가능 하다.

**R1의 터널 인터페이스 설정**

interface Tunnel1

ip address 10.100.100.1 255.255.255.0

tunnel source GigabitEthernet0/1

tunnel destination 20.0.0.2

ip route 192.168.100.0 255.255.255.0 10.100.100.3 (= Tunnel 3)

![[%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-06-29_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_9.39.32.png]]

  

**R3의 터널 인터페이스 설정**

interface Tunnel3

ip address 10.100.100.3 255.255.255.0

tunnel source Serial 0/0/0

tunnel destination 172.16.0.1

ip route 192.168.200.0 255.255.255.0 10.100.100.1(= Tunnel 1)

![[%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-06-29_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_9.28.19.png]]

- 위의 작업에서 10.100.100.1 과 10.100.100.3 과 같은 중복되지 않는 사설 네트워크 대역을 추가적으로 부여 함으로서 둘을 터널링 하여 연결시킨다(직접 연결 X , 기존 경로로 이동한다).  
    

![[%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-06-29_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_9.49.34.png]]

- PC0에서 출발시 목적지 주소는 192.168.100.100 을 가지고 있다

  

![[%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-06-29_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_9.41.38.png]]

- 라우터 0 에서 데이터의 목적지 주소가 20.0.0.2로 변경되게 된다.
    - tunnel 은 기존에 갈 수 없던 경로를 말 그대로 새로운 tunnel을 뚫어 갈 수 있도록 해준다.
    - tunnelling : 기존에는 갈 수 없었던 목적지 정보인 라우팅 정보(L3)에 새로운 정보를 추가해주어(New L3) 해당 정보를 사용하여 중간 라우터의 정보없이 갈 수 있도록 해준다.
    - Tunnel의 끝 라우터에 도착하면, New L3 정보를 떼어내고, 기존 L3 정보를 사용하여 목적지 까지 이동 할 수 있게 된다.
        - **이것이 VPN 이다.**

## IPSec, SSL/TLS :

- VPN에서 목적지 정보를 가진 L3 이후 (L4, L7) 의 모든 데이터를 암호화 해서 통신하는 프로토콜

VPN을 쉽게 이해 할 수 있는 예)

- PC방의 PC방 혜택을 집에서 누릴 수 있는 서비스.
    - PC방의 IP를 사용하여 집에서 PC를 사용하더라도 PC방에 트래픽을 우회하여 보내도록 함으로서 PC방 혜택을 누릴 수 있다.

## IPSec

R1)

- 1단계 : 키 교환 단계
    
    crypto isakmp policy 10
    
    encryption 3des
    
    hash md5
    
    → hash 는 데이터의 원본을 보장해준다(데이터의 변조 방지) 변환 전, 후의 데이터가 똑같아야 한다는 조건이 있음.
    
    authentication pre-share
    
    → 통신 상대가 맞는지 확인 (보통 인증서를 사용)
    
      
    
    crypto isakmp key cisco address 20.0.0.2
    
    → cisco의 키를 사용(통신 상대도 cisco 형태의 key를 가지고 있어야 함)
    
      
    
- 2단계 : IPSec 단계
    
    → 1단계와 다른 프로토콜을 사용해도 되지만, 상대방도 2단계에서 진행된 프로토콜과 같은 프로토콜을 사용하고 있어야함.
    
    crypto ipsec transform-set r1-ts esp-aes esp-sha-hmac
    
      
    
- 보호할 트래픽 지정 : ACL로 분류
    
    ip access-list extended r1-vpn
    
    permit ip 192.168.200.0 0.0.0.255 192.168.100.0 0.0.0.255
    
      
    
- crypto map 생성

crypto map r1vpn 10 ipsec-isakmp

set peer 20.0.0.2

→ 터널 끝

set transform-set r1-ts

→ 사용할 프로토콜

match address r1-vpn

→ 보호할 트래픽

  

- 인터페이스에 VPN을 적용

int g0/1

crypto map r1vpn

  

R3)

- 1단계 : 키 교환 단계
    
    crypto isakmp policy 10
    
    encryption 3des
    
    hash md5
    
    → hash 는 데이터의 원본을 보장해준다(데이터의 변조 방지) 변환 전, 후의 데이터가 똑같아야 한다는 조건이 있음.
    
    authentication pre-share
    
    → 통신 상대가 맞는지 확인 (보통 인증서를 사용)
    
      
    
    crypto isakmp key cisco address 172.16.0.1
    
    → cisco의 키를 사용(통신 상대도 cisco 형태의 key를 가지고 있어야 함)
    
      
    
- 2단계 : IPSec 단계
    
    → 1단계와 다른 프로토콜을 사용해도 되지만, 상대방도 2단계에서 진행된 프로토콜과 같은 프로토콜을 사용하고 있어야함.
    
    crypto ipsec transform-set r3-ts esp-aes esp-sha-hmac
    
      
    
- (중요)보호할 트래픽 지정 : ACL로 분류
    
      
    
    ip access-list extended r3-vpn
    
    permit ip 192.168.100.0 0.0.0.255 192.168.200.0 0.0.0.255
    
      
    
- crypto map 생성

crypto map r3vpn 10 ipsec-isakmp

set peer 172.16.0.1

→ 터널 끝

set transform-set r3-ts

→ 사용할 프로토콜

match address r3-vpn

→ 보호할 트래픽

  

- 인터페이스에 VPN을 적용

int s0/0/0

crypto map r3vpn

  

  

**VPN Samples (Remote VPN)**

- PC0, 1이 VPN server 라우터와 통신하여 VPN을 설정(암호화).

  

![[%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-06-29_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_11.18.21.png]]

- PC0 에서 AAA서버로 ping이 가지 않는 것을 볼 수 있다.

  

![[%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-06-29_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_11.24.03.png]]

- VPN 설정 모습.

  

![[%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-06-29_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_11.22.46.png]]

- VPN 설정 후 ping이 AAA server로 잘 가는 것을 볼 수 있다.

  

![[%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-06-29_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_11.20.31.png]]

- ip config 실행 시,
    - VPN 설정 후 연결된 Tunnel의 IP를 볼 수 있다.

# SSL / TLS - HTTPS

## HTTP

- 암호화가 되지 않은 상태.

## HTTPS

- 암호화 된 통신

Telnet

- 암호화 x

ssh

- 암호화 o

ssh 와 https의 암호화 방식은 결과적으로 같다.

**암호화 방식**

1. 대칭 키 암호화
    - 암/복호화 키가 동일하다. → 속도가 빠름.
    - 키 교환이 어려움. → 상대방에게 키를 알려줘야 한다(노출 될 가능성이 생긴다).
2. 공개 키 암호화
    - 암/복호화 키가 분리됨 (개인 키 / 공개 키)
    - 개인 키로 암호화 → 공개 키로 복호화
    - 공개 키로 암호화 → 개인 키로 복호화

- SSH 암호화
    1. 인증 시 공개 키 암호화 사용
        - 자신의 개인 키와 상대방의 공개 키 간의 인증.
    2. 데이터 암호화 시 대칭 키 암호화
        - 데이터 암호화 시 사용된 대칭 키(세션 키)는 공개 키 암호화를 통해 안전하게 교환됨.
- HTTPS 암호화 → 인증서 내부에 공개 키가 존재
    
    1. 인증서(공개 키)를 이용하여 상대방을 인증
        - 인증된 기관 (CA)의 브라우저에 저장되어 있는 키를 인증서로 사용
    2. 이 때 공개 키 방식 암호화를 이용하여 세션 키를 교환한 후에 데이터를 암호화 함.
    
      
    
    ![[%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-06-29_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_11.43.07.png]]
    

1.브라우저는 서버에 연결하려는 요청을 보내고 보안 페이지(일반적으로 문서)를 요청합니다.

2.웹 서버는 서명 인증서와 함께 공개 키를 클라이언트로 다시 보냅니다.  
3.브라우저는 인증서가 신뢰하는 CA에서 발급했는지 여부를 확인합니다. 클라이언트는 인증서에 있는 정 보와 웹사이트에서 받은 정보를 비교하여 모든 내용을 확인합니다. 그렇다면 브라우저는 녹색 자물쇠를 표 시하여 서버 인증서의 순도를 표시하고 클라이언트는 계속 진행합니다.  
4.브라우저는 무작위 대칭 암호화 키를 생성한 다음 서버의 공개 키로 암호화합니다. 마지막으로 암호화된 URL 및 기타 암호화된 HTTP 데이터와 함께 서버로 보냅니다.  
5.웹 서버는 수신 패킷을 자신의 개인 키를 사용하여 복호화하고 대칭 키를 사용하여 클라이언트 측에서 무 작위로 생성된 URL 및 HTTP 데이터를 복호화합니다.  
6.그런 다음 대칭 키로 암호화된 다른 데이터와 함께 클라이언트에서 요청한 문서가 브라우저로 다시 전송 됩니다.  
7.마지막으로 브라우저는 대칭 키를 사용하여 패킷을 해독하고 보안 핸드셰이킹이 설정됩니다.